<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CornipickleParser.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cornipickle</a> &gt; <a href="index.source.html" class="el_package">ca.uqac.lif.cornipickle</a> &gt; <span class="el_source">CornipickleParser.java</span></div><h1>CornipickleParser.java</h1><pre class="source lang-java linenums">package ca.uqac.lif.cornipickle;
/*
    Cornipickle, validation of layout bugs in web applications
    Copyright (C) 2015 Sylvain Hall√©

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */


import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Stack;
import java.util.Vector;

import ca.uqac.lif.bullwinkle.BnfParser;
import ca.uqac.lif.bullwinkle.BnfParser.InvalidGrammarException;
import ca.uqac.lif.bullwinkle.BnfRule;
import ca.uqac.lif.bullwinkle.CaptureBlockParseNode;
import ca.uqac.lif.bullwinkle.ParseNode;
import ca.uqac.lif.bullwinkle.ParseNodeVisitor;
import ca.uqac.lif.cornipickle.json.JsonNumber;
import ca.uqac.lif.cornipickle.util.PackageFileReader;
import ca.uqac.lif.util.EmptyException;

public class CornipickleParser implements ParseNodeVisitor 
{
  public BnfParser m_parser;
  
  protected Stack&lt;LanguageElement&gt; m_nodes;
  
  protected Map&lt;String,PredicateDefinition&gt; m_predicateDefinitions;
  
  protected int m_predicateCount;

  public CornipickleParser()
  {
<span class="fc" id="L52">    super();</span>
<span class="fc" id="L53">    m_predicateCount = 0;</span>
<span class="fc" id="L54">    m_parser = initializeParser();</span>
<span class="fc" id="L55">    m_predicateDefinitions = new HashMap&lt;String,PredicateDefinition&gt;();</span>
<span class="fc" id="L56">    reset();</span>
<span class="fc" id="L57">  }</span>
  
  public List&lt;PredicateDefinition&gt; getPredicates()
  {
<span class="nc" id="L61">  	List&lt;PredicateDefinition&gt; out = new LinkedList&lt;PredicateDefinition&gt;();</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">  	for (String k : m_predicateDefinitions.keySet())</span>
  	{
<span class="nc" id="L64">  		PredicateDefinition pd = m_predicateDefinitions.get(k);</span>
<span class="nc" id="L65">  		out.add(pd);</span>
<span class="nc" id="L66">  	}</span>
<span class="nc" id="L67">  	return out;</span>
  }

  public void reset()
  {
<span class="fc" id="L72">    m_nodes = new Stack&lt;LanguageElement&gt;();</span>
<span class="fc" id="L73">  }</span>

  protected static InputStream getGrammarStream()
  {
<span class="fc" id="L77">    return CornipickleParser.class.getResourceAsStream(&quot;cornipickle.bnf&quot;);</span>
  }

  protected BnfParser getParser()
  {
<span class="fc" id="L82">    return m_parser;</span>
  }

  /**
   * Initializes the BNF parser
   * @return The initialized BNF parser
   */
  public static BnfParser initializeParser()
  {
<span class="fc" id="L91">    BnfParser parser = new BnfParser();</span>
<span class="fc" id="L92">    String grammar = null;</span>
    try
    {
<span class="fc" id="L95">      grammar = PackageFileReader.readPackageFile(getGrammarStream());</span>
<span class="fc" id="L96">      parser.setGrammar(grammar);</span>
    } 
<span class="nc" id="L98">    catch (IOException e)</span>
    {
<span class="nc" id="L100">      e.printStackTrace();</span>
    } 
<span class="nc" id="L102">    catch (InvalidGrammarException e)</span>
    {
<span class="nc" id="L104">      e.printStackTrace();</span>
<span class="pc" id="L105">    }</span>
    //parser.setDebugMode(true);
<span class="fc" id="L107">    return parser;</span>
  }

  public Statement parseStatement(String property) throws ParseException
  {
<span class="fc" id="L112">    LanguageElement el = parseLanguage(property);</span>
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">    if (el == null || !(el instanceof Statement))</span>
<span class="nc" id="L114">      return null;</span>
<span class="fc" id="L115">    return (Statement) el;</span>
  }

  public LanguageElement parseLanguage(String property) throws ParseException
  {
<span class="fc" id="L120">    ParseNode node = null;</span>
    try
    {
<span class="fc" id="L123">      node = m_parser.parse(property);</span>
    }
<span class="nc" id="L125">    catch (BnfParser.ParseException e)</span>
    {
<span class="nc" id="L127">      throw new ParseException(e.toString());</span>
<span class="fc" id="L128">    }</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">    if (node != null)</span>
    {
<span class="fc" id="L131">      return parseStatement(node);</span>
    }
    else
    {
<span class="nc" id="L135">      throw new ParseException(&quot;Error: the BNF parser returned null&quot;);</span>
    }
    //return null;    
  }

  protected LanguageElement parseStatement(ParseNode root)
  {
<span class="fc" id="L142">    reset();</span>
<span class="fc" id="L143">    root.postfixAccept(this);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">    if (m_nodes.isEmpty())</span>
    {
<span class="nc" id="L146">      return null;</span>
    }
<span class="fc" id="L148">    return m_nodes.peek();</span>
  }
  
  public void addPredicateDefinition(PredicateDefinition pd)
  {
    // Add rules to the parser
<span class="nc" id="L154">    String rule_name = &quot;USERDEFRULE&quot; + m_predicateCount; // So that each predicate is unique</span>
<span class="nc" id="L155">    pd.setRuleName(rule_name);</span>
<span class="nc" id="L156">    BnfRule rule = pd.getRule();</span>
<span class="nc" id="L157">    m_parser.addRule(rule);</span>
<span class="nc" id="L158">    m_parser.addCaseToRule(&quot;&lt;userdef_stmt&gt;&quot;, &quot;&lt;&quot; + rule_name + &quot;&gt;&quot;);</span>
    // Add definition
<span class="nc" id="L160">    m_predicateDefinitions.put(rule_name, pd);</span>
<span class="nc" id="L161">    m_predicateCount++;</span>
<span class="nc" id="L162">  }</span>

  @Override
  public void visit(ParseNode node)
  {
<span class="fc" id="L167">    String node_token =  node.getToken();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">    if (node instanceof CaptureBlockParseNode)</span>
    {
<span class="nc" id="L170">      CaptureBlock cb = new CaptureBlock(node_token);</span>
<span class="nc" id="L171">      m_nodes.push(cb);</span>
<span class="nc" id="L172">      return;</span>
    }
<span class="fc bfc" id="L174" title="All 2 branches covered.">    if (node_token.compareTo(&quot;&lt;binary_stmt&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;constant&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;css_attribute&gt;&quot;) == 0) { }</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;el_or_not&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;elem_property&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;number&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;pred_pattern&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;property_or_const&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;S&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;statement&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;temporal_stmt&gt;&quot;) == 0) { }</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;userdef_set&gt;&quot;) == 0) { }</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;userdef_stmt&gt;&quot;) == 0) { }</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;var_name&gt;&quot;) == 0) { }</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;math&gt;&quot;) == 0) { }</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;add&gt;&quot;) == 0) </span>
    { 
<span class="nc" id="L191">      m_nodes.pop(); //(</span>
<span class="nc" id="L192">      NumberConstant right = (NumberConstant) m_nodes.pop();</span>
<span class="nc" id="L193">      m_nodes.pop(); // plus</span>
<span class="nc" id="L194">      NumberConstant left = (NumberConstant) m_nodes.pop();</span>
<span class="nc" id="L195">      m_nodes.pop(); //)</span>
<span class="nc" id="L196">      AddOperation out = new AddOperation(left, right);</span>
<span class="nc" id="L197">      m_nodes.push(out);</span>
<span class="nc" id="L198">    }</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;and&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L201">      m_nodes.pop(); // (</span>
<span class="nc" id="L202">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L203">      m_nodes.pop(); // )</span>
<span class="nc" id="L204">      m_nodes.pop(); // And</span>
<span class="nc" id="L205">      m_nodes.pop(); // (</span>
<span class="nc" id="L206">      Statement left = (Statement) m_nodes.pop();</span>
<span class="nc" id="L207">      m_nodes.pop(); // )</span>
<span class="nc" id="L208">      AndStatement out = new AndStatement();</span>
<span class="nc" id="L209">      out.addOperand(left);</span>
<span class="nc" id="L210">      out.addOperand(right);</span>
<span class="nc" id="L211">      m_nodes.push(out);</span>
<span class="nc" id="L212">    }</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;css_selector&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L215">      m_nodes.pop(); // )</span>
<span class="fc" id="L216">      CssSelector out = (CssSelector) m_nodes.pop();</span>
<span class="fc" id="L217">      m_nodes.pop(); // $(</span>
<span class="fc" id="L218">      m_nodes.push(out);</span>
<span class="fc" id="L219">    }</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;css_sel_contents&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L222">      CssSelector sel = (CssSelector) m_nodes.pop();</span>
<span class="fc" id="L223">      LanguageElement top = m_nodes.peek();</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">      if (top instanceof CssSelector)</span>
      {
        // Merge both selectors
<span class="fc" id="L227">        CssSelector right = (CssSelector) m_nodes.pop();</span>
<span class="fc" id="L228">        sel.mergeWith(right);</span>
      }
<span class="fc" id="L230">      m_nodes.push(sel);</span>
<span class="fc" id="L231">    }</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;css_sel_part&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L234">      StringConstant part = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L235">      CssSelector out = new CssSelector(part);</span>
<span class="fc" id="L236">      m_nodes.push(out);</span>
<span class="fc" id="L237">    }</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;def_set&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L240">      ElementList set_elements = (ElementList) m_nodes.pop();</span>
<span class="fc" id="L241">      m_nodes.pop(); // of</span>
<span class="fc" id="L242">      m_nodes.pop(); // any</span>
<span class="fc" id="L243">      m_nodes.pop(); // is</span>
<span class="fc" id="L244">      StringConstant set_name = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L245">      m_nodes.pop(); // A</span>
<span class="fc" id="L246">      SetDefinitionExtension out = new SetDefinitionExtension(set_name, set_elements);</span>
<span class="fc" id="L247">      m_nodes.push(out);</span>
<span class="fc" id="L248">    }</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;def_set_element&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L251">      Property part = (Property) m_nodes.pop();</span>
<span class="fc" id="L252">      ElementList out = new ElementList();</span>
<span class="fc" id="L253">      out.add(part);</span>
<span class="fc" id="L254">      m_nodes.push(out);</span>
<span class="fc" id="L255">    }</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;def_set_elements&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L258">      ElementList sel = (ElementList) m_nodes.pop();</span>
      while (true)
      {
<span class="fc" id="L261">        LanguageElement top = m_nodes.peek();</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (top instanceof StringConstant)</span>
        {
<span class="fc" id="L264">          StringConstant s = (StringConstant) top;</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">          if (s.toString().compareTo(&quot;,&quot;) == 0)</span>
          {
<span class="fc" id="L267">            m_nodes.pop(); // ,</span>
            // Merge both lists
<span class="fc" id="L269">            ElementList right = (ElementList) m_nodes.pop();</span>
<span class="fc" id="L270">            sel.addAll(right);</span>
          }
          else
          {
            break;
          }
        }
        else
        {
          break;
        }
<span class="fc" id="L281">      }</span>
<span class="fc" id="L282">      m_nodes.push(sel);</span>
<span class="fc" id="L283">    }</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;def_set_name&gt;&quot;) == 0)</span>
    {
      // Trim spaces
<span class="fc" id="L287">      LanguageElement el = m_nodes.pop();</span>
<span class="fc" id="L288">      StringConstant sc = (StringConstant) el;</span>
<span class="fc" id="L289">      String s = sc.toString();</span>
<span class="fc" id="L290">      s = s.trim();</span>
<span class="fc" id="L291">      m_nodes.push(new StringConstant(s));</span>
<span class="fc" id="L292">    }</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;eventually&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L295">      m_nodes.pop(); // (</span>
<span class="nc" id="L296">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L297">      m_nodes.pop(); // )</span>
<span class="nc" id="L298">      m_nodes.pop(); // Eventually</span>
<span class="nc" id="L299">      Eventually out = new Eventually();</span>
<span class="nc" id="L300">      out.setInnerStatement(right);</span>
<span class="nc" id="L301">      m_nodes.push(out);</span>
<span class="nc" id="L302">    }</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;exists&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L305">      m_nodes.pop(); // )</span>
<span class="fc" id="L306">      Statement statement = (Statement) m_nodes.pop();</span>
<span class="fc" id="L307">      m_nodes.pop(); // (</span>
<span class="fc" id="L308">      m_nodes.pop(); // that</span>
<span class="fc" id="L309">      m_nodes.pop(); // such</span>
<span class="fc" id="L310">      SetExpression set_name = (SetExpression) m_nodes.pop();</span>
<span class="fc" id="L311">      m_nodes.pop(); // in</span>
<span class="fc" id="L312">      StringConstant var_name = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L313">      m_nodes.pop(); // exists</span>
<span class="fc" id="L314">      m_nodes.pop(); // There</span>
<span class="fc" id="L315">      ExistsStatement out = new ExistsStatement();</span>
<span class="fc" id="L316">      out.setDomain(set_name);</span>
<span class="fc" id="L317">      out.setInnerStatement(statement);</span>
<span class="fc" id="L318">      out.setVariable(var_name);</span>
<span class="fc" id="L319">      m_nodes.push(out);</span>
<span class="fc" id="L320">    }</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;foreach&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L323">      m_nodes.pop(); // )</span>
<span class="fc" id="L324">      Statement statement = (Statement) m_nodes.pop();</span>
<span class="fc" id="L325">      m_nodes.pop(); // (</span>
<span class="fc" id="L326">      SetExpression set_name = (SetExpression) m_nodes.pop();</span>
<span class="fc" id="L327">      m_nodes.pop(); // in</span>
<span class="fc" id="L328">      StringConstant var_name = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L329">      m_nodes.pop(); // each</span>
<span class="fc" id="L330">      m_nodes.pop(); // For</span>
<span class="fc" id="L331">      ForAllStatement out = new ForAllStatement();</span>
<span class="fc" id="L332">      out.setDomain(set_name);</span>
<span class="fc" id="L333">      out.setInnerStatement(statement);</span>
<span class="fc" id="L334">      out.setVariable(var_name);</span>
<span class="fc" id="L335">      m_nodes.push(out);</span>
<span class="fc" id="L336">    }</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;equality&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L339">      Property right = (Property) m_nodes.pop();</span>
<span class="fc" id="L340">      m_nodes.pop(); // equals / is</span>
<span class="fc" id="L341">      Property left = (Property) m_nodes.pop();</span>
<span class="fc" id="L342">      EqualsStatement out = new EqualsStatement();</span>
<span class="fc" id="L343">      out.setLeft(left);</span>
<span class="fc" id="L344">      out.setRight(right);</span>
<span class="fc" id="L345">      m_nodes.push(out);</span>
<span class="fc" id="L346">    }</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;elem_property_pos&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L349">      StringConstant sel = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L350">      m_nodes.pop(); // 's</span>
<span class="fc" id="L351">      StringConstant var = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L352">      ElementPropertyPossessive out = new ElementPropertyPossessive(var, sel);</span>
<span class="fc" id="L353">      m_nodes.push(out);</span>
<span class="fc" id="L354">    }</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;elem_property_com&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L357">      StringConstant var = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L358">      m_nodes.pop(); // of</span>
<span class="fc" id="L359">      StringConstant sel = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L360">      m_nodes.pop(); // the</span>
<span class="fc" id="L361">      ElementPropertyComplement out = new ElementPropertyComplement(var, sel);</span>
<span class="fc" id="L362">      m_nodes.push(out);</span>
<span class="fc" id="L363">    }</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;globally&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L366">      m_nodes.pop(); // (</span>
<span class="nc" id="L367">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L368">      m_nodes.pop(); // )</span>
<span class="nc" id="L369">      m_nodes.pop(); // Globally</span>
<span class="nc" id="L370">      Globally out = new Globally();</span>
<span class="nc" id="L371">      out.setInnerStatement(right);</span>
<span class="nc" id="L372">      m_nodes.push(out);</span>
<span class="nc" id="L373">    }</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;gt&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L376">      Property right = (Property) m_nodes.pop();</span>
<span class="fc" id="L377">      m_nodes.pop(); // than</span>
<span class="fc" id="L378">      m_nodes.pop(); // greater</span>
<span class="fc" id="L379">      m_nodes.pop(); // is</span>
<span class="fc" id="L380">      Property left = (Property) m_nodes.pop();</span>
<span class="fc" id="L381">      GreaterThanStatement out = new GreaterThanStatement();</span>
<span class="fc" id="L382">      out.setLeft(left);</span>
<span class="fc" id="L383">      out.setRight(right);</span>
<span class="fc" id="L384">      m_nodes.push(out);</span>
<span class="fc" id="L385">    }</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;implies&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L388">    	m_nodes.pop(); // )</span>
<span class="nc" id="L389">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L390">      m_nodes.pop(); // (</span>
<span class="nc" id="L391">      m_nodes.pop(); // Then</span>
<span class="nc" id="L392">      m_nodes.pop(); // )</span>
<span class="nc" id="L393">      Statement left = (Statement) m_nodes.pop();</span>
<span class="nc" id="L394">      m_nodes.pop(); // (</span>
<span class="nc" id="L395">      m_nodes.pop(); // If</span>
<span class="nc" id="L396">      ImpliesStatement out = new ImpliesStatement();</span>
<span class="nc" id="L397">      out.addOperand(left);</span>
<span class="nc" id="L398">      out.addOperand(right);</span>
<span class="nc" id="L399">      m_nodes.push(out);</span>
<span class="nc" id="L400">    }</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;lt&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L403">      Property right = (Property) m_nodes.pop();</span>
<span class="nc" id="L404">      m_nodes.pop(); // than</span>
<span class="nc" id="L405">      m_nodes.pop(); // less</span>
<span class="nc" id="L406">      m_nodes.pop(); // is</span>
<span class="nc" id="L407">      Property left = (Property) m_nodes.pop();</span>
<span class="nc" id="L408">      LessThanStatement out = new LessThanStatement();</span>
<span class="nc" id="L409">      out.setLeft(left);</span>
<span class="nc" id="L410">      out.setRight(right);</span>
<span class="nc" id="L411">      m_nodes.push(out);</span>
<span class="nc" id="L412">    }</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;let&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L415">      m_nodes.pop(); // )</span>
<span class="fc" id="L416">      Statement inner = (Statement) m_nodes.pop();</span>
<span class="fc" id="L417">      m_nodes.pop(); // (</span>
<span class="fc" id="L418">      Property prop = (Property) m_nodes.pop();</span>
<span class="fc" id="L419">      m_nodes.pop(); // be</span>
<span class="fc" id="L420">      StringConstant var = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L421">      m_nodes.pop(); // let</span>
<span class="fc" id="L422">      LetStatement out = new LetStatement(var, prop);</span>
<span class="fc" id="L423">      out.setStatement(inner);</span>
<span class="fc" id="L424">      m_nodes.push(out);</span>
<span class="fc" id="L425">    }</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;negation&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L428">      m_nodes.pop(); // (</span>
<span class="nc" id="L429">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L430">      m_nodes.pop(); // )</span>
<span class="nc" id="L431">      m_nodes.pop(); // Not</span>
<span class="nc" id="L432">      NegationStatement out = new NegationStatement();</span>
<span class="nc" id="L433">      out.setInnerStatement(right);</span>
<span class="nc" id="L434">      m_nodes.push(out);</span>
<span class="nc" id="L435">    }</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;next&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L438">      m_nodes.pop(); // (</span>
<span class="nc" id="L439">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L440">      m_nodes.pop(); // )</span>
<span class="nc" id="L441">      m_nodes.pop(); // Next</span>
<span class="nc" id="L442">      Next out = new Next();</span>
<span class="nc" id="L443">      out.setInnerStatement(right);</span>
<span class="nc" id="L444">      m_nodes.push(out);</span>
<span class="nc" id="L445">    }</span>
<span class="fc bfc" id="L446" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;next_time&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L448">      m_nodes.pop(); // )</span>
<span class="fc" id="L449">      Statement right = (Statement) m_nodes.pop();</span>
<span class="fc" id="L450">      m_nodes.pop(); // (</span>
<span class="fc" id="L451">      m_nodes.pop(); // then</span>
<span class="fc" id="L452">      m_nodes.pop(); // )</span>
<span class="fc" id="L453">      Statement left = (Statement) m_nodes.pop();</span>
<span class="fc" id="L454">      m_nodes.pop(); // (</span>
<span class="fc" id="L455">      m_nodes.pop(); // time</span>
<span class="fc" id="L456">      m_nodes.pop(); // next</span>
<span class="fc" id="L457">      m_nodes.pop(); // The</span>
<span class="fc" id="L458">      NextTime out = new NextTime();</span>
<span class="fc" id="L459">      out.setLeft(left);</span>
<span class="fc" id="L460">      out.setRight(right);</span>
<span class="fc" id="L461">      m_nodes.push(out);</span>
<span class="fc" id="L462">    }</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;never&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L465">      m_nodes.pop(); // (</span>
<span class="nc" id="L466">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L467">      m_nodes.pop(); // )</span>
<span class="nc" id="L468">      m_nodes.pop(); // Never</span>
<span class="nc" id="L469">      Never out = new Never();</span>
<span class="nc" id="L470">      out.setInnerStatement(right);</span>
<span class="nc" id="L471">      m_nodes.push(out);</span>
<span class="nc" id="L472">    }</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;or&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L475">      m_nodes.pop(); // (</span>
<span class="nc" id="L476">      Statement right = (Statement) m_nodes.pop();</span>
<span class="nc" id="L477">      m_nodes.pop(); // )</span>
<span class="nc" id="L478">      m_nodes.pop(); // Or</span>
<span class="nc" id="L479">      m_nodes.pop(); // (</span>
<span class="nc" id="L480">      Statement left = (Statement) m_nodes.pop();</span>
<span class="nc" id="L481">      m_nodes.pop(); // )</span>
<span class="nc" id="L482">      OrStatement out = new OrStatement();</span>
<span class="nc" id="L483">      out.addOperand(left);</span>
<span class="nc" id="L484">      out.addOperand(right);</span>
<span class="nc" id="L485">      m_nodes.push(out);</span>
<span class="nc" id="L486">    }</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;predicate&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L489">      m_nodes.pop(); // )</span>
<span class="fc" id="L490">      Statement statement = (Statement) m_nodes.pop();</span>
<span class="fc" id="L491">      m_nodes.pop(); // (</span>
<span class="fc" id="L492">      m_nodes.pop(); // when</span>
<span class="fc" id="L493">      StringConstant pattern = (StringConstant) m_nodes.pop();</span>
<span class="fc" id="L494">      m_nodes.pop(); // that</span>
<span class="fc" id="L495">      m_nodes.pop(); // say</span>
<span class="fc" id="L496">      m_nodes.pop(); // We</span>
<span class="fc" id="L497">      StringConstant rule_name = new StringConstant(&quot;TODO:userdef&quot;);</span>
<span class="fc" id="L498">      PredicateDefinition out = new PredicateDefinition(rule_name);</span>
<span class="fc" id="L499">      out.setPattern(pattern);</span>
<span class="fc" id="L500">      out.setStatement(statement);</span>
<span class="fc" id="L501">      m_nodes.push(out);</span>
<span class="fc" id="L502">    }</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;regex_capture&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L505">      StringConstant pattern = (StringConstant) m_nodes.pop();</span>
<span class="nc" id="L506">      m_nodes.pop(); // with</span>
<span class="nc" id="L507">      ElementPropertyPossessive variable = (ElementPropertyPossessive) m_nodes.pop();</span>
<span class="nc" id="L508">      m_nodes.pop(); // match</span>
<span class="nc" id="L509">      RegexCapture out = new RegexCapture();</span>
<span class="nc" id="L510">      out.setProperty(variable);</span>
<span class="nc" id="L511">      out.setPattern(pattern.toString());</span>
<span class="nc" id="L512">      m_nodes.push(out);</span>
<span class="nc" id="L513">    }</span>
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;regex_match&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L516">      Property right = (Property) m_nodes.pop();</span>
<span class="nc" id="L517">      m_nodes.pop(); // matches</span>
<span class="nc" id="L518">      Property left = (Property) m_nodes.pop();</span>
<span class="nc" id="L519">      RegexMatch out = new RegexMatch();</span>
<span class="nc" id="L520">      out.setLeft(left);</span>
<span class="nc" id="L521">      out.setRight(right);</span>
<span class="nc" id="L522">      m_nodes.push(out);</span>
<span class="nc" id="L523">    }</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;set_name&gt;&quot;) == 0)</span>
    {
<span class="fc" id="L526">      LanguageElement el = m_nodes.pop();</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">      if (el instanceof CssSelector)</span>
      {
<span class="fc" id="L529">        m_nodes.push(el);</span>
      }
<span class="nc bnc" id="L531" title="All 2 branches missed.">      else if (el instanceof RegexCapture)</span>
      {
<span class="nc" id="L533">        m_nodes.push(el);</span>
      }
<span class="nc bnc" id="L535" title="All 2 branches missed.">      else if (el instanceof StringConstant)</span>
      {
<span class="nc" id="L537">        StringConstant set_name = (StringConstant) el;</span>
<span class="nc" id="L538">        SetDefinition sd = new SetDefinition(set_name.toString());</span>
<span class="nc" id="L539">        m_nodes.push(sd);</span>
      }
<span class="fc" id="L541">    }</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">    else if (node_token.compareTo(&quot;&lt;string&gt;&quot;) == 0)</span>
    {
      // Trim quotes
<span class="fc" id="L545">      LanguageElement el = m_nodes.pop();</span>
<span class="fc" id="L546">      StringConstant sc = (StringConstant) el;</span>
<span class="fc" id="L547">      String s = sc.toString();</span>
<span class="fc" id="L548">      s = s.replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="fc" id="L549">      m_nodes.push(new StringConstant(s));</span>
<span class="fc" id="L550">    }</span>
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">    else if (node_token.compareTo(&quot;&lt;when&gt;&quot;) == 0)</span>
    {
<span class="nc" id="L553">      m_nodes.pop(); // (</span>
<span class="nc" id="L554">      Statement in_statement = (Statement) m_nodes.pop();</span>
<span class="nc" id="L555">      m_nodes.pop(); // )</span>
<span class="nc" id="L556">      StringConstant var_after = (StringConstant) m_nodes.pop();</span>
<span class="nc" id="L557">      m_nodes.pop(); // now</span>
<span class="nc" id="L558">      m_nodes.pop(); // is</span>
<span class="nc" id="L559">      StringConstant var_before = (StringConstant) m_nodes.pop();</span>
<span class="nc" id="L560">      m_nodes.pop(); // When</span>
<span class="nc" id="L561">      WhenIsNow out = new WhenIsNow(var_before, var_after);</span>
<span class="nc" id="L562">      out.setStatement(in_statement);</span>
<span class="nc" id="L563">      m_nodes.push(out);</span>
<span class="nc" id="L564">    }</span>
    else
    {
      // This is a node that does not contain a label
      // Guess if this is a string or a number
<span class="fc bfc" id="L569" title="All 2 branches covered.">      if (JsonNumber.isNumeric(node_token))</span>
      {
<span class="fc" id="L571">        NumberConstant out = new NumberConstant(node_token);</span>
<span class="fc" id="L572">        m_nodes.push(out);</span>
<span class="fc" id="L573">      }</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">      else if (node_token.startsWith(&quot;&lt;&quot;))</span>
      {
        // Most probably a user-defined non-terminal token
<span class="nc" id="L577">        StringConstant pattern = (StringConstant) m_nodes.pop(); // The pattern that was matched</span>
        // Remove stack of any regex capture blocks associated to the match
<span class="nc" id="L579">        Vector&lt;String&gt; capture_blocks = new Vector&lt;String&gt;();</span>
<span class="nc bnc" id="L580" title="All 4 branches missed.">        while (!m_nodes.isEmpty() &amp;&amp; m_nodes.peek() instanceof CaptureBlock)</span>
        {
<span class="nc" id="L582">          CaptureBlock cb = (CaptureBlock) m_nodes.pop();</span>
<span class="nc" id="L583">          capture_blocks.add(0, cb.toString());</span>
<span class="nc" id="L584">        }</span>
<span class="nc" id="L585">        String predicate_name = node_token;</span>
<span class="nc" id="L586">        predicate_name = predicate_name.replaceAll(&quot;&lt;&quot;, &quot;&quot;);</span>
<span class="nc" id="L587">        predicate_name = predicate_name.replaceAll(&quot;&gt;&quot;, &quot;&quot;);</span>
        // In predicate call, put a reference to the predicate's definition
<span class="nc" id="L589">        PredicateDefinition pred_def = m_predicateDefinitions.get(predicate_name);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (pred_def == null)</span>
        {
<span class="nc" id="L592">          System.err.println(&quot;Could not find definition for &quot; + predicate_name);</span>
          //throw new ParseException(&quot;Could not find definition for &quot; + predicate_name);
        }
<span class="nc" id="L595">        PredicateCall out = new PredicateCall(pred_def, pattern.toString(), capture_blocks);</span>
<span class="nc" id="L596">        m_nodes.push(out);</span>
<span class="nc" id="L597">      }</span>
      else
      {
        // A normal string
<span class="fc" id="L601">        StringConstant out = new StringConstant(node_token);</span>
<span class="fc" id="L602">        m_nodes.push(out);</span>
      }
    } 
<span class="fc" id="L605">  }</span>

  @Override
  public void pop()
  {
    // Nothing to do
<span class="fc" id="L611">  }</span>

  public static class ParseException extends EmptyException
  {
    /**
     * Dummy UID
     */
    private static final long serialVersionUID = 1L;

    public ParseException(String message)
    {
<span class="nc" id="L622">      super(message);</span>
<span class="nc" id="L623">    }</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>